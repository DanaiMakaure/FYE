<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments - spu first year</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Global Styles - RED & WHITE theme */
        :root {
            /* Primary Colors - red & white */
            --primary-red: #b22222;      /* firebrick */
            --primary-light-red: #dc143c; /* crimson */
            --primary-dark-red: #8b0000;  /* darkred */
            
            /* Neutrals */
            --black: #000000;
            --dark-gray: #333333;
            --medium-gray: #666666;
            --light-gray: #E5E5E5;
            --white: #FFFFFF;
            
            /* Accents - all red */
            --light-purple: var(--primary-light-red);
            --light-orange: var(--primary-red);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: var(--black);
            overflow-x: hidden;
        }

        /* Top Navigation Bar */
        .top-navbar {
            background-color: var(--white);
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .back-button {
            font-size: 24px;
            color: var(--primary-red);
            margin-right: 15px;
            cursor: pointer;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-red);
            margin-right: 20px;
            flex: 1;
            text-align: center;
        }

        .profile-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Main Content */
        .main-content {
            padding-top: 80px;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        /* Post */
        .post {
            background-color: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--light-gray);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-header .profile-pic {
            margin-right: 10px;
        }

        .post-user-info h4 {
            font-size: 15px;
            margin-bottom: 2px;
        }

        .post-user-info p {
            font-size: 12px;
            color: var(--medium-gray);
        }

        .post-content {
            margin-bottom: 15px;
        }

        .post-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .post-footer {
            border-top: 1px solid var(--light-gray);
            padding-top: 10px;
        }

        .post-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--medium-gray);
            font-size: 14px;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--light-gray);
            padding-top: 5px;
        }

        .post-action {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 8px 0;
            border-radius: 5px;
            cursor: pointer;
        }

        .post-action:hover {
            background-color: var(--light-gray);
        }

        .post-action i {
            margin-right: 8px;
            color: var(--primary-red);
        }

        /* Comments Section */
        .comments-header {
            font-size: 18px;
            margin: 20px 0 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
            color: var(--primary-red);
        }

        .comment-disclaimer {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-red);
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: var(--medium-gray);
            border-radius: 0 4px 4px 0;
        }
        
        .comment-disclaimer i {
            color: var(--primary-red);
            margin-right: 8px;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
            background-color: var(--white);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--light-gray);
        }

        .comment-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--light-gray);
            margin-bottom: 10px;
            font-size: 14px;
        }
        .comment-input:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        .comment-anonymous {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e4e6eb;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--primary-red);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .comment-media-preview {
            position: relative;
            margin-bottom: 10px;
        }

        .comment-media-preview img, .comment-media-preview video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        .remove-media {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .media-upload-btn {
            background-color: var(--light-gray);
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: var(--dark-gray);
        }
        .media-upload-btn i {
            color: var(--primary-red);
        }

        .comment-submit {
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            align-self: flex-end;
        }
        .comment-submit:hover {
            background-color: var(--primary-dark-red);
        }

        .comment {
            display: flex;
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 1px solid var(--light-gray);
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .comment-author {
            font-weight: bold;
            font-size: 14px;
            margin-right: 5px;
        }

        .comment-time {
            font-size: 12px;
            color: var(--medium-gray);
        }

        .comment-text {
            font-size: 14px;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .comment-media {
            margin-top: 10px;
            max-width: 100%;
        }

        .comment-media img, .comment-media video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
        }

        .comment-actions {
            display: flex;
            margin-top: 5px;
            font-size: 12px;
        }

        .comment-action {
            margin-right: 15px;
            color: var(--medium-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .comment-action i {
            margin-right: 5px;
            color: var(--primary-red);
        }

        /* Reply Section */
        .reply-form {
            display: none;
            margin-top: 10px;
            padding-left: 50px;
        }

        .reply-form.active {
            display: block;
        }

        .reply-input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid var(--light-gray);
            margin-bottom: 8px;
            font-size: 14px;
        }
        .reply-input:focus {
            border-color: var(--primary-red);
            outline: none;
        }

        .reply-submit {
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
        }
        .reply-submit:hover {
            background-color: var(--primary-dark-red);
        }

        .replies {
            margin-top: 10px;
            padding-left: 50px;
            border-left: 2px solid var(--light-gray);
        }

        .reply {
            display: flex;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            position: relative;
        }

        /* Emoji Picker */
        .emoji-picker {
            position: relative;
            display: inline-block;
        }

        .emoji-picker-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--medium-gray);
            font-size: 18px;
            margin-right: 10px;
        }

        .emoji-picker-container {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display: none;
        }

        .emoji-picker-container.show {
            display: block;
        }

        .emoji-option {
            font-size: 20px;
            margin: 0 3px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .emoji-option:hover {
            transform: scale(1.3);
        }

        /* Reaction buttons */
        .reaction-options {
            position: absolute;
            bottom: 100%;
            left: 0;
            display: none;
            background: white;
            border-radius: 30px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .reaction-option {
            font-size: 20px;
            margin: 0 3px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.3);
        }

        .like-action:hover .reaction-options {
            display: flex;
        }

        /* Comment Options */
        .comment-options {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .comment-options-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--medium-gray);
            font-size: 16px;
        }

        .comment-options-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: var(--white);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none;
            min-width: 120px;
        }

        .comment-options-menu.show {
            display: block;
        }

        .comment-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .comment-option:hover {
            background-color: var(--light-gray);
        }

        .comment-option i {
            width: 18px;
            text-align: center;
            color: var(--primary-red);
        }

        /* Reaction display */
        .reaction-display {
            display: flex;
            align-items: center;
            margin-left: 5px;
        }

        .reaction-display span {
            font-size: 14px;
            margin-left: 3px;
        }

        /* Loading indicator */
        .loading-comments {
            text-align: center;
            color: var(--medium-gray);
            padding: 10px;
            font-size: 14px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--medium-gray);
        }

        .modal-body {
            padding: 15px;
        }

        .report-reasons {
            margin: 15px 0;
        }

        .report-reason {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .report-reason input {
            margin-right: 10px;
        }

        .report-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            margin-bottom: 15px;
            resize: vertical;
        }

        .report-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .report-button {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .report-cancel {
            background-color: var(--light-gray);
            border: none;
        }

        .report-submit {
            background-color: var(--primary-red);
            color: white;
            border: none;
        }
        .report-submit:hover {
            background-color: var(--primary-dark-red);
        }

        /* File input */
        .file-input {
            display: none;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
                padding-top: 70px;
            }
            
            .post, .comment, .comment-form {
                border-radius: 8px;
            }
            
            .reply-form, .replies {
                padding-left: 30px;
            }
        }

        @media (max-width: 576px) {
            .top-navbar {
                padding: 0 10px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .comment-action span {
                display: none;
            }
            
            .comment-action i {
                margin-right: 0;
                font-size: 16px;
            }
            
            .comment-options-menu {
                min-width: 100px;
            }
        }
        /* No panic button, no chatbot, no wall of honor, no emergency numbers */
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-navbar">
        <div class="back-button" id="backButton">
            <i class="fas fa-arrow-left"></i>
        </div>
        <div class="logo">spu first year</div>
        <div class="profile-nav">
            <div class="profile-pic" id="userProfilePic">
                <img src="logo.jpg" alt="Profile Picture">
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Post -->
        <div class="post" id="postContainer">
            <!-- Post will be loaded here dynamically -->
        </div>

        <!-- Comments Section -->
        <h3 class="comments-header">Comments</h3>
        
        <div class="comment-disclaimer">
            <i class="fas fa-heart"></i>
            Remember to be kind and respectful in your comments. 
            This is a safe space for sharing and support.
        </div>

        <!-- Comment Form -->
        <form class="comment-form" id="commentForm">
            <input type="text" class="comment-input" id="commentInput" placeholder="Write a comment..." required>
            
            <div id="commentMediaPreview" class="comment-media-preview" style="display: none;">
                <button type="button" class="remove-media" id="removeCommentMedia">
                    <i class="fas fa-times"></i>
                </button>
                <img id="commentMediaPreviewImg" style="display: none;">
                <video id="commentMediaPreviewVideo" controls style="display: none;"></video>
            </div>
            
            <input type="file" id="commentMediaInput" class="file-input" accept="image/*, video/*">
            <button type="button" class="media-upload-btn" id="commentMediaBtn">
                <i class="fas fa-camera"></i> Add Photo/Video
            </button>
            
            <div class="comment-anonymous">
                <label class="toggle-switch">
                    <input type="checkbox" id="commentAnonymousToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span>Post Anonymously</span>
            </div>
            <button type="submit" class="comment-submit">Post</button>
        </form>

        <!-- Comments List -->
        <div id="commentsList">
            <!-- Comments will be loaded here dynamically -->
            <div class="loading-comments">Loading comments...</div>
        </div>
    </div>

    <!-- Report Comment Modal -->
    <div class="modal" id="reportCommentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Comment</h3>
                <button class="close-modal" id="closeReportCommentModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Please select a reason for reporting this comment:</p>
                <div class="report-reasons">
                    <div class="report-reason">
                        <input type="radio" id="commentReason1" name="commentReportReason" value="Inappropriate Content">
                        <label for="commentReason1">Inappropriate Content</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="commentReason2" name="commentReportReason" value="Harassment or Bullying">
                        <label for="commentReason2">Harassment or Bullying</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="commentReason3" name="commentReportReason" value="False Information">
                        <label for="commentReason3">False Information</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="commentReason4" name="commentReportReason" value="Spam">
                        <label for="commentReason4">Spam</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="commentReason5" name="commentReportReason" value="Other">
                        <label for="commentReason5">Other</label>
                    </div>
                </div>
                <textarea class="report-textarea" id="commentReportDetails" placeholder="Please provide additional details..." rows="4"></textarea>
                <div class="report-buttons">
                    <button class="report-button report-cancel" id="cancelCommentReport">Cancel</button>
                    <button class="report-button report-submit" id="submitCommentReport">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Reply Modal -->
    <div class="modal" id="reportReplyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Reply</h3>
                <button class="close-modal" id="closeReportReplyModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Please select a reason for reporting this reply:</p>
                <div class="report-reasons">
                    <div class="report-reason">
                        <input type="radio" id="replyReason1" name="replyReportReason" value="Inappropriate Content">
                        <label for="replyReason1">Inappropriate Content</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="replyReason2" name="replyReportReason" value="Harassment or Bullying">
                        <label for="replyReason2">Harassment or Bullying</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="replyReason3" name="replyReportReason" value="False Information">
                        <label for="replyReason3">False Information</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="replyReason4" name="replyReportReason" value="Spam">
                        <label for="replyReason4">Spam</label>
                    </div>
                    <div class="report-reason">
                        <input type="radio" id="replyReason5" name="replyReportReason" value="Other">
                        <label for="replyReason5">Other</label>
                    </div>
                </div>
                <textarea class="report-textarea" id="replyReportDetails" placeholder="Please provide additional details..." rows="4"></textarea>
                <div class="report-buttons">
                    <button class="report-button report-cancel" id="cancelReplyReport">Cancel</button>
                    <button class="report-button report-submit" id="submitReplyReport">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            get, 
            set, 
            onValue,
            push,
            update,
            child,
            remove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { 
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-ijctWgf-FjsvUZdHKRzz9J8iWIxBuZw",
            authDomain: "qhawelami-57d2b.firebaseapp.com",
            databaseURL: "https://qhawelami-57d2b-default-rtdb.firebaseio.com",
            projectId: "qhawelami-57d2b",
            storageBucket: "qhawelami-57d2b.appspot.com",
            messagingSenderId: "858135773981",
            appId: "1:858135773981:web:ff945efe6ec6f2518bd7f4",
            measurementId: "G-LHTYR7MGH9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // DOM Elements
        const backButton = document.getElementById('backButton');
        const userProfilePic = document.getElementById('userProfilePic');
        const postContainer = document.getElementById('postContainer');
        const commentForm = document.getElementById('commentForm');
        const commentInput = document.getElementById('commentInput');
        const commentsList = document.getElementById('commentsList');
        const commentAnonymousToggle = document.getElementById('commentAnonymousToggle');
        const reportCommentModal = document.getElementById('reportCommentModal');
        const closeReportCommentModal = document.getElementById('closeReportCommentModal');
        const cancelCommentReport = document.getElementById('cancelCommentReport');
        const submitCommentReport = document.getElementById('submitCommentReport');
        const reportReplyModal = document.getElementById('reportReplyModal');
        const closeReportReplyModal = document.getElementById('closeReportReplyModal');
        const cancelReplyReport = document.getElementById('cancelReplyReport');
        const submitReplyReport = document.getElementById('submitReplyReport');
        const commentMediaInput = document.getElementById('commentMediaInput');
        const commentMediaBtn = document.getElementById('commentMediaBtn');
        const commentMediaPreview = document.getElementById('commentMediaPreview');
        const commentMediaPreviewImg = document.getElementById('commentMediaPreviewImg');
        const commentMediaPreviewVideo = document.getElementById('commentMediaPreviewVideo');
        const removeCommentMedia = document.getElementById('removeCommentMedia');

        // State variables
        let currentUser = null;
        let userData = {};
        let postId = null;
        let postData = {};
        let commentsData = {};
        let currentCommentToReport = null;
        let currentReplyToReport = null;
        let currentReplyCommentId = null;
        let commentMediaFile = null;

        // Initialize the comments page
        function initComments() {
            // Get post ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get('id');
            
            if (!postId) {
                window.location.href = 'home.html';
                return;
            }
            
            setupEventListeners();
            checkAuthState();
            loadPost();
            loadComments();
        }

        // Check authentication state
        function checkAuthState() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        // Load user data from Firebase
        function loadUserData(userId) {
            const userRef = ref(database, `users/${userId}`);
            
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    userData = data;
                    updateProfileUI(data);
                }
            });
        }

        // Update profile UI elements
        function updateProfileUI(data) {
            if (data.photoURL) {
                userProfilePic.querySelector('img').src = data.photoURL;
            } else {
                const initial = data.name ? data.name.charAt(0).toUpperCase() : 'U';
                const placeholder = `https://ui-avatars.com/api/?name=${initial}&background=b22222&color=fff`;
                userProfilePic.querySelector('img').src = placeholder;
            }
        }

        // Load the post from Firebase
        function loadPost() {
            const postRef = ref(database, `posts/${postId}`);
            
            get(postRef).then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    postData = data;
                    displayPost(data);
                } else {
                    window.location.href = 'home.html';
                }
            });
        }

        // Display the post
        function displayPost(post) {
            const postDate = new Date(post.timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const formattedDate = postDate.toLocaleDateString('en-US', options);
            
            const isAnonymous = post.anonymous;
            const userName = isAnonymous ? 'Anonymous' : (post.authorName || 'User');
            const userAvatar = isAnonymous ? 
                'https://ui-avatars.com/api/?name=A&background=b22222&color=fff' : 
                (post.authorPhotoURL || 'https://via.placeholder.com/150');
            
            const hasLiked = post.likes && post.likes[currentUser?.uid] === true;
            
            postContainer.innerHTML = `
                <div class="post-header">
                    <div class="profile-pic">
                        <img src="${userAvatar}" alt="Profile Picture">
                    </div>
                    <div class="post-user-info">
                        <h4>${userName}</h4>
                        <p>${formattedDate}</p>
                        ${post.location ? `<p><i class="fas fa-map-marker-alt"></i> ${post.location}</p>` : ''}
                    </div>
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
                    ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" alt="Post image">` : ''}
                </div>
                <div class="post-footer">
                    <div class="post-stats">
                        <span>${post.likes ? Object.keys(post.likes).length : 0} likes</span>
                        <span>${post.commentCount || 0} comments</span>
                    </div>
                    <div class="post-actions">
                        <div class="post-action like-action">
                            <i class="far ${hasLiked ? 'fa-thumbs-up' : 'fa-thumbs-up'}"></i>
                            <span>${hasLiked ? 'Liked' : 'Like'}</span>
                            <div class="reaction-options">
                                <span class="reaction-option" data-reaction="üëç">üëç</span>
                                <span class="reaction-option" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</span>
                                <span class="reaction-option" data-reaction="üòÆ">üòÆ</span>
                                <span class="reaction-option" data-reaction="üò¢">üò¢</span>
                                <span class="reaction-option" data-reaction="üò°">üò°</span>
                            </div>
                        </div>
                        <div class="post-action comment-action">
                            <i class="far fa-comment"></i>
                            <span>Comment</span>
                        </div>
                        <div class="post-action share-action">
                            <i class="fas fa-share"></i>
                            <span>Share</span>
                        </div>
                    </div>
                </div>
            `;
            
            addPostEventListeners();
        }

        // Load comments from Firebase
        function loadComments() {
            const commentsRef = ref(database, `posts/${postId}/comments`);
            
            onValue(commentsRef, (snapshot) => {
                const comments = snapshot.val() || {};
                commentsData = comments;
                displayComments(comments);
            });
        }

        // Display comments
        function displayComments(comments) {
            commentsList.innerHTML = '';
            
            if (Object.keys(comments).length === 0) {
                commentsList.innerHTML = '<div class="loading-comments">No comments yet. Be the first to comment!</div>';
                return;
            }
            
            const commentsArray = Object.entries(comments).map(([id, comment]) => ({ id, ...comment }));
            commentsArray.sort((a, b) => a.timestamp - b.timestamp);
            
            commentsArray.forEach(comment => {
                const commentElement = createCommentElement(comment);
                commentsList.appendChild(commentElement);
            });
        }

        // Create a comment element (simplified for readability, includes reply structure)
        function createCommentElement(comment) {
            const isAnonymous = comment.anonymous;
            const userName = isAnonymous ? 'Anonymous' : (comment.authorName || 'User');
            const userAvatar = isAnonymous ? 
                'https://ui-avatars.com/api/?name=A&background=b22222&color=fff' : 
                (comment.authorPhotoURL || 'https://via.placeholder.com/150');
            
            const commentDate = new Date(comment.timestamp);
            const formattedDate = commentDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            const hasLiked = comment.likes && comment.likes[currentUser?.uid] === true;
            const isAuthor = (comment.authorId === currentUser?.uid);
            
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.dataset.commentId = comment.id;
            
            commentElement.innerHTML = `
                <div class="comment-avatar">
                    <img src="${userAvatar}" alt="Profile Picture">
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${userName}</span>
                        <span class="comment-time">${formattedDate}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                    ${comment.mediaUrl ? 
                        comment.mediaType === 'image' ? 
                            `<div class="comment-media"><img src="${comment.mediaUrl}" alt="Comment media"></div>` :
                            `<div class="comment-media"><video src="${comment.mediaUrl}" controls></video></div>`
                        : ''
                    }
                    <div class="comment-actions">
                        <span class="comment-action like-comment" data-comment-id="${comment.id}">
                            <i class="far ${hasLiked ? 'fa-thumbs-up' : 'fa-thumbs-up'}"></i>
                            ${comment.likes ? Object.keys(comment.likes).length : 0} Likes
                        </span>
                        <span class="comment-action reply-comment" data-comment-id="${comment.id}">
                            <i class="far fa-comment-dots"></i> Reply
                        </span>
                    </div>
                </div>
                <div class="comment-options">
                    <button class="comment-options-btn">‚ãÆ</button>
                    <div class="comment-options-menu">
                        ${isAuthor ? `
                            <div class="comment-option delete-comment" data-comment-id="${comment.id}">
                                <i class="fas fa-trash"></i>
                                <span>Delete</span>
                            </div>
                        ` : ''}
                        <div class="comment-option report-comment" data-comment-id="${comment.id}">
                            <i class="fas fa-flag"></i>
                            <span>Report</span>
                        </div>
                    </div>
                </div>
                <form class="reply-form" id="replyForm_${comment.id}">
                    <input type="text" class="reply-input" placeholder="Write a reply..." required>
                    <button type="submit" class="reply-submit">Reply</button>
                </form>
            `;
            
            // Event listeners (simplified)
            const likeBtn = commentElement.querySelector('.like-comment');
            likeBtn.addEventListener('click', () => toggleLikeComment(comment.id));
            
            const replyBtn = commentElement.querySelector('.reply-comment');
            const replyForm = commentElement.querySelector(`#replyForm_${comment.id}`);
            replyBtn.addEventListener('click', () => replyForm.classList.toggle('active'));
            
            replyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const input = replyForm.querySelector('.reply-input');
                const replyText = input.value.trim();
                if (replyText) {
                    addReply(comment.id, replyText);
                    input.value = '';
                    replyForm.classList.remove('active');
                }
            });
            
            return commentElement;
        }

        // Add comment
        async function addComment(commentText) {
            if (!currentUser) return;
            if (!commentText && !commentMediaFile) {
                alert('Please enter text or add media');
                return;
            }
            
            let mediaUrl = null, mediaType = null;
            if (commentMediaFile) {
                try {
                    const fileRef = storageRef(storage, `comments/${postId}/${Date.now()}_${commentMediaFile.name}`);
                    await uploadBytes(fileRef, commentMediaFile);
                    mediaUrl = await getDownloadURL(fileRef);
                    mediaType = commentMediaFile.type.startsWith('image/') ? 'image' : 'video';
                } catch (error) {
                    alert('Upload failed');
                    return;
                }
            }
            
            const commentsRef = ref(database, `posts/${postId}/comments`);
            const newCommentRef = push(commentsRef);
            const isAnonymous = commentAnonymousToggle.checked;
            
            set(newCommentRef, {
                text: commentText,
                authorId: isAnonymous ? 'anonymous' : currentUser.uid,
                authorName: isAnonymous ? null : (userData.name || 'User'),
                authorPhotoURL: isAnonymous ? null : (userData.photoURL || null),
                anonymous: isAnonymous,
                timestamp: Date.now(),
                likes: {},
                replies: {},
                ...(mediaUrl && { mediaUrl, mediaType })
            });
            
            // Update comment count
            update(ref(database, `posts/${postId}`), {
                commentCount: (postData.commentCount || 0) + 1
            });
            
            commentInput.value = '';
            commentAnonymousToggle.checked = false;
            commentMediaFile = null;
            commentMediaPreview.style.display = 'none';
            commentMediaInput.value = '';
        }

        async function addReply(commentId, replyText, mediaUrl = null, mediaType = null, parentReplyId = null) {
            if (!currentUser) return;
            const path = parentReplyId ? 
                `posts/${postId}/comments/${commentId}/replies/${parentReplyId}/replies` :
                `posts/${postId}/comments/${commentId}/replies`;
            const repliesRef = ref(database, path);
            const newReplyRef = push(repliesRef);
            set(newReplyRef, {
                text: replyText,
                authorId: currentUser.uid,
                authorName: userData.name || 'User',
                authorPhotoURL: userData.photoURL || null,
                timestamp: Date.now(),
                likes: {},
                replies: {},
                ...(mediaUrl && { mediaUrl, mediaType })
            });
        }

        function toggleLikeComment(commentId) {
            if (!currentUser) return;
            const likeRef = ref(database, `posts/${postId}/comments/${commentId}/likes/${currentUser.uid}`);
            const hasLiked = commentsData[commentId]?.likes?.[currentUser.uid] === true;
            set(likeRef, hasLiked ? null : true);
        }

        function deleteComment(commentId) {
            if (!currentUser) return;
            remove(ref(database, `posts/${postId}/comments/${commentId}`))
                .then(() => updateCommentCount(-1))
                .catch(console.error);
        }

        function updateCommentCount(change) {
            update(ref(database, `posts/${postId}`), {
                commentCount: (postData.commentCount || 0) + change
            });
        }

        function setupEventListeners() {
            backButton.addEventListener('click', () => window.location.href = 'home.html');
            userProfilePic.addEventListener('click', () => window.location.href = 'dashboard.html');

            commentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addComment(commentInput.value.trim());
            });

            commentMediaBtn.addEventListener('click', () => commentMediaInput.click());
            commentMediaInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    commentMediaFile = file;
                    commentMediaPreview.style.display = 'block';
                    if (file.type.startsWith('image/')) {
                        commentMediaPreviewImg.style.display = 'block';
                        commentMediaPreviewVideo.style.display = 'none';
                        commentMediaPreviewImg.src = URL.createObjectURL(file);
                    } else if (file.type.startsWith('video/')) {
                        commentMediaPreviewImg.style.display = 'none';
                        commentMediaPreviewVideo.style.display = 'block';
                        commentMediaPreviewVideo.src = URL.createObjectURL(file);
                    }
                }
            });
            removeCommentMedia.addEventListener('click', () => {
                commentMediaFile = null;
                commentMediaPreview.style.display = 'none';
                commentMediaInput.value = '';
            });

            // Report modals
            closeReportCommentModal.addEventListener('click', () => reportCommentModal.style.display = 'none');
            cancelCommentReport.addEventListener('click', () => reportCommentModal.style.display = 'none');
            submitCommentReport.addEventListener('click', () => {
                const reason = document.querySelector('input[name="commentReportReason"]:checked')?.value;
                const details = document.getElementById('commentReportDetails').value;
                if (reason) {
                    alert('Report submitted (demo)');
                    reportCommentModal.style.display = 'none';
                } else alert('Select a reason');
            });
            closeReportReplyModal.addEventListener('click', () => reportReplyModal.style.display = 'none');
            cancelReplyReport.addEventListener('click', () => reportReplyModal.style.display = 'none');
            submitReplyReport.addEventListener('click', () => {
                const reason = document.querySelector('input[name="replyReportReason"]:checked')?.value;
                if (reason) {
                    alert('Reply report submitted (demo)');
                    reportReplyModal.style.display = 'none';
                } else alert('Select a reason');
            });

            // Delete/report handlers
            document.addEventListener('click', (e) => {
                if (e.target.closest('.delete-comment')) {
                    const commentId = e.target.closest('.comment-option').dataset.commentId;
                    if (confirm('Delete this comment?')) deleteComment(commentId);
                }
                if (e.target.closest('.report-comment')) {
                    const commentId = e.target.closest('.comment-option').dataset.commentId;
                    reportCommentModal.style.display = 'flex';
                }
            });
        }

        function addPostEventListeners() {
            const likePost = document.querySelector('.like-action');
            if (likePost) {
                likePost.addEventListener('click', () => {
                    const likeRef = ref(database, `posts/${postId}/likes/${currentUser.uid}`);
                    const hasLiked = postData.likes?.[currentUser?.uid] === true;
                    set(likeRef, hasLiked ? null : true);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', initComments);
    </script>
</body>
</html>